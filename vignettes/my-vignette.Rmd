---
title: "Getting Started with the scp Package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{my-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=6, 
  fig.height=5.5
)
```

```{r setup, echo=FALSE}
suppressMessages(library(scp))
suppressMessages(library(fields))
suppressMessages(library(viridis))
```

Library `scp` helps you create spatial prediction intervals without assumption of underlying spatial process. For example, if you are interested in identifying the prediction interval for locations $(0.25, 0.25), (0.5, 0.5)$, and $(0.75, 0.75)$ in the following spatial process $Y(s)$, which is obviously non-stationary. 


```{r example spatial process}
s  = sample_data$s
Y  = sample_data$Y
quilt.plot(s, Y, col = viridis(50, option = "D"), nx = 41, ny = 41)

s0 = rbind(c(0.25, 0.25), c(0.5, 0.5), c(0.75, 0.75))
text(s0[,1], s0[,2], col = "red", labels=1:nrow(s0), cex = 1.5)
```

You could simply start with the `scp` function, which returns a lower bound and upper bound for the 95% predictin intervals.

```{r scp usage}
alpha = 0.05
scp(s0, s, Y, alpha = alpha)
```

<!-- The true value for the locations are -->
<!-- ```{r true value, echo = FALSE} -->
<!-- for(i in 1:nrow(s0)){ -->
<!--   idx = which(s[,1] == s0[i,1] & s[,2] == s0[i,2]) -->
<!--   print(Y[idx]) -->
<!-- } -->
<!-- ``` -->

<!-- ```{r krige result} -->
<!-- krige_result = apply(s0, 1, FUN = krige_pred, s = s, Y = Y, return_sd = TRUE) -->
<!-- do.call(rbind, lapply(krige_result, FUN = function(x) x$yhat + qnorm(1-alpha/2)*c(-1,1)*x$sd)) -->
<!-- ``` -->

The idea of spatial conformal prediction is inherited from conformal prediction algorithm, which can calculate the plausibility of $Y(s_{0})$ being $Y_0$. For example, the following code calculates the plausibility of $Y(0.5, 0.5)$ being 0. For more details about plausibility, please refer to Mao. et al. (2020) section 2.2. 

```{r plausibiltiy}
plausibility(Y0=0,s0=c(0.5,0.5),s=s,Y=Y)
```

Connecting all possible $Y$ values and their plausibility, we could have
```{r plausibility contour}
pc = plausibility_contour(s0=c(0.5,0.5),s=s,Y=Y)
plot(pc)
abline(h = 0.05, col = "red", lty = 2)
abline(h = 0.2, col = "blue", lty = 3)
```

The 95% prediction interval for location $(0.5,0.5)$ is just the level set corresponding to $\alpha = 0.05$, the red dash line i.e., `r paste(c("[", round(scp(s0=c(0.5,0.5), s=s, Y=Y), digits = 2), "]"), collapse = " ")`.

